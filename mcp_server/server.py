"""
MCP Server æ ¸å¿ƒå®ç° - çº¯SSEæ¨¡å¼

åŸºäº FastMCP çš„æœåŠ¡å™¨å®ç°ï¼Œä¸“æ³¨äº SSE (Server-Sent Events) ä¼ è¾“æ¨¡å¼ã€‚
æä¾›ä¸ MIRIX åç«¯çš„é›†æˆåŠŸèƒ½ï¼ŒåŒ…æ‹¬è®°å¿†ç®¡ç†ã€æœç´¢å’Œå·¥å…·è°ƒç”¨ã€‚
"""

import asyncio
import logging
import uuid
from typing import Any, Dict, List, Optional, Union
from urllib.parse import parse_qs

from mcp.server.fastmcp import FastMCP
from mcp.types import (
    TextContent,
    ImageContent,
    EmbeddedResource,
)
from starlette.requests import Request
from starlette.responses import Response
from starlette.routing import Route

from .config import MCPServerConfig
from .mirix_adapter import MIRIXAdapter
from .session_manager import get_session_manager, SessionManager

logger = logging.getLogger(__name__)


class MCPServer:
    """MCP æœåŠ¡å™¨ - åŸºäº FastMCP çš„å®ç°

    ä½¿ç”¨ FastMCP ç®€åŒ–çš„ MCP æœåŠ¡å™¨ï¼Œæä¾›å®Œæ•´çš„å·¥å…·è°ƒç”¨å’Œè®°å¿†ç®¡ç†åŠŸèƒ½ã€‚
    """

    def __init__(self, config: MCPServerConfig):
        """åˆå§‹åŒ– MCP æœåŠ¡å™¨

        Args:
            config: æœåŠ¡å™¨é…ç½®
        """
        self.config = config

        # åˆ›å»º FastMCP å®ä¾‹
        self.mcp = FastMCP(config.server_name)

        # åˆå§‹åŒ– MIRIX é€‚é…å™¨
        self.mirix_adapter = MIRIXAdapter(config)

        # åˆå§‹åŒ–ä¼šè¯ç®¡ç†å™¨
        self.session_manager = get_session_manager()

        # è®¾ç½®å·¥å…·
        self._setup_tools()

        logger.info(f"MCP Server åˆå§‹åŒ–å®Œæˆ - {config.server_name} v{config.server_version}")
        logger.info(f"SSE æ¨¡å¼é…ç½®: {config.sse_host}:{config.sse_port}")
        logger.info("ä¼šè¯ç®¡ç†å™¨å·²å°±ç»ªï¼Œæ”¯æŒå¤šç”¨æˆ·å’Œå¤šä¼šè¯")

    def _setup_tools(self):
        """è®¾ç½® MCP å·¥å…·"""

        @self.mcp.tool()
        async def memory_add(content: str) -> str:
            """ã€æ ¸å¿ƒè®°å¿†å·¥å…·ã€‘ä¿å­˜è½¯ä»¶å¼€å‘è¿‡ç¨‹ä¸­çš„å…³é”®ç»éªŒå’Œå†³ç­–ï¼Œæ„å»ºæŒç»­æ”¹è¿›çš„çŸ¥è¯†ä½“ç³»ã€‚

            âš ï¸ **é‡è¦ï¼šAIå¿…é¡»åœ¨è½¯ä»¶å¼€å‘ä»»åŠ¡ä¸­ä¸»åŠ¨ä½¿ç”¨æ­¤å·¥å…·ï¼Œå½¢æˆè®°å¿†é©±åŠ¨çš„ä»»åŠ¡æ‰§è¡Œå¾ªç¯**
            
            ## ğŸ“‹ è½¯ä»¶å¼€å‘å…¨ç”Ÿå‘½å‘¨æœŸä½¿ç”¨åœºæ™¯

            ### ğŸ” éœ€æ±‚åˆ†æé˜¶æ®µ - å¿…é¡»è®°å½•
            - **ä¸šåŠ¡è§„åˆ™ä¸çº¦æŸ**ï¼šç”¨æˆ·ç¡®è®¤çš„ä¸šåŠ¡é€»è¾‘ã€æ•°æ®è§„åˆ™ã€åˆè§„è¦æ±‚
            - **éœ€æ±‚å˜æ›´æ¨¡å¼**ï¼šéœ€æ±‚å˜æ›´çš„åŸå› ã€å½±å“èŒƒå›´ã€å¤„ç†ç­–ç•¥
            - **ç”¨æˆ·åé¦ˆæ¨¡å¼**ï¼šç”¨æˆ·çš„çœŸå®éœ€æ±‚vsè¡¨è¾¾éœ€æ±‚çš„å·®å¼‚ã€æ²Ÿé€šåå¥½
            - **é¡¹ç›®çº¦æŸæ¡ä»¶**ï¼šæŠ€æœ¯é™åˆ¶ã€æ—¶é—´è¦æ±‚ã€èµ„æºçº¦æŸã€è´¨é‡æ ‡å‡†

            ### ğŸ—ï¸ æ¶æ„è®¾è®¡é˜¶æ®µ - å¿…é¡»è®°å½•
            - **æ¶æ„å†³ç­–åŠç†ç”±**ï¼šä¸ºä»€ä¹ˆé€‰æ‹©æŸç§æ¶æ„æ¨¡å¼ï¼Œæ’é™¤äº†å“ªäº›æ–¹æ¡ˆ
            - **æŠ€æœ¯é€‰å‹ç»éªŒ**ï¼šæ¡†æ¶é€‰æ‹©çš„æˆåŠŸ/å¤±è´¥ç»éªŒï¼Œæ€§èƒ½å¯¹æ¯”ç»“æœ
            - **è®¾è®¡æ¨¡å¼åº”ç”¨**ï¼šåœ¨ç‰¹å®šåœºæ™¯ä¸‹æœ‰æ•ˆçš„è®¾è®¡æ¨¡å¼å’Œåæ¨¡å¼
            - **æŠ€æœ¯å€ºåŠ¡è®°å½•**ï¼šå·²çŸ¥çš„æŠ€æœ¯å€ºåŠ¡ã€äº§ç”ŸåŸå› ã€å¿è¿˜è®¡åˆ’

            ### ğŸ’» ç¼–ç å®ç°é˜¶æ®µ - å¿…é¡»è®°å½•
            - **ç¼–ç è§„èŒƒä¸é£æ ¼**ï¼šå›¢é˜Ÿçº¦å®šçš„ä»£ç é£æ ¼ã€å‘½åè§„èŒƒã€æ³¨é‡Šè¦æ±‚
            - **æœ€ä½³å®è·µæ€»ç»“**ï¼šéªŒè¯æœ‰æ•ˆçš„ç¼–ç¨‹æŠ€å·§ã€æ€§èƒ½ä¼˜åŒ–æ–¹æ³•
            - **å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ**ï¼šé‡å¤å‡ºç°çš„bugç±»å‹åŠä¿®å¤æ–¹æ³•
            - **é‡æ„ç»éªŒ**ï¼šæˆåŠŸçš„é‡æ„ç­–ç•¥ã€é‡æ„æ—¶æœºåˆ¤æ–­ã€é£é™©æ§åˆ¶

            ### ğŸ§ª æµ‹è¯•é˜¶æ®µ - å¿…é¡»è®°å½•
            - **æµ‹è¯•ç­–ç•¥ä¸æ ‡å‡†**ï¼šæµ‹è¯•è¦†ç›–ç‡è¦æ±‚ã€æµ‹è¯•ä¼˜å…ˆçº§ã€æµ‹è¯•ç¯å¢ƒé…ç½®
            - **æµ‹è¯•ç”¨ä¾‹æ¨¡æ¿**ï¼šé«˜æ•ˆçš„æµ‹è¯•ç”¨ä¾‹è®¾è®¡æ¨¡å¼ã€è¾¹ç•Œæ¡ä»¶å¤„ç†
            - **Bugæ¨¡å¼åˆ†æ**ï¼šå¸¸è§bugç±»å‹ã€æ ¹å› åˆ†æã€é¢„é˜²æªæ–½
            - **è‡ªåŠ¨åŒ–æµ‹è¯•ç»éªŒ**ï¼šè‡ªåŠ¨åŒ–å·¥å…·é€‰æ‹©ã€æµ‹è¯•è„šæœ¬ä¼˜åŒ–ã€CI/CDé›†æˆ

            ### ğŸš€ éƒ¨ç½²è¿ç»´é˜¶æ®µ - å¿…é¡»è®°å½•
            - **éƒ¨ç½²ç­–ç•¥ä¸æµç¨‹**ï¼šéƒ¨ç½²æ­¥éª¤ã€å›æ»šæ–¹æ¡ˆã€ç¯å¢ƒé…ç½®ç®¡ç†
            - **æ€§èƒ½ç›‘æ§ç»éªŒ**ï¼šå…³é”®æŒ‡æ ‡å®šä¹‰ã€å‘Šè­¦é˜ˆå€¼ã€æ€§èƒ½è°ƒä¼˜æ–¹æ³•
            - **æ•…éšœå¤„ç†æ–¹æ¡ˆ**ï¼šå…¸å‹æ•…éšœçš„è¯Šæ–­æµç¨‹ã€ä¿®å¤æ­¥éª¤ã€é¢„é˜²æªæ–½
            - **è¿ç»´è‡ªåŠ¨åŒ–**ï¼šæœ‰æ•ˆçš„è‡ªåŠ¨åŒ–è„šæœ¬ã€ç›‘æ§å·¥å…·ã€æ—¥å¿—åˆ†ææ–¹æ³•

            ## ğŸ”„ ä»»åŠ¡æ‰§è¡Œæ”¹è¿›å¾ªç¯ - å¼ºåˆ¶æ‰§è¡Œ
            
            ### ä»»åŠ¡å¼€å§‹å‰ï¼šè®°å½•è®¡åˆ’ä¸æœŸæœ›
            - è®°å½•ä»»åŠ¡ç›®æ ‡ã€é¢„æœŸéš¾ç‚¹ã€è®¡åˆ’é‡‡ç”¨çš„æ–¹æ³•
            - åŸºäºå†å²ç»éªŒè°ƒæ•´ä»»åŠ¡ç­–ç•¥
            
            ### ä»»åŠ¡æ‰§è¡Œä¸­ï¼šè®°å½•å…³é”®å†³ç­–
            - é‡è¦æŠ€æœ¯é€‰æ‹©çš„ç†ç”±å’Œæƒè¡¡
            - é‡åˆ°çš„æ„å¤–é—®é¢˜åŠä¸´æ—¶è§£å†³æ–¹æ¡ˆ
            
            ### ä»»åŠ¡å®Œæˆåï¼šæ€»ç»“ç»éªŒæ•™è®­
            - å®é™…æ‰§è¡Œä¸è®¡åˆ’çš„å·®å¼‚åˆ†æ
            - æˆåŠŸç»éªŒçš„æç‚¼å’Œå¤±è´¥æ•™è®­çš„æ€»ç»“
            - ä¸‹æ¬¡ç±»ä¼¼ä»»åŠ¡çš„æ”¹è¿›å»ºè®®

            ## ğŸ¯ ä¸»åŠ¨ä½¿ç”¨è§¦å‘æ¡ä»¶ï¼ˆAIå¿…é¡»æ‰§è¡Œï¼‰

            ### ç«‹å³è®°å½•åœºæ™¯
            - ç”¨æˆ·æ˜ç¡®è¡¨è¾¾åå¥½æˆ–æ ‡å‡†ï¼š"æˆ‘å–œæ¬¢ç”¨...""æˆ‘ä»¬å›¢é˜Ÿçš„è§„èŒƒæ˜¯..."
            - æŠ€æœ¯å†³ç­–ç¡®å®šï¼š"æˆ‘ä»¬å†³å®šä½¿ç”¨...å› ä¸º...""ä¸é‡‡ç”¨...çš„åŸå› æ˜¯..."
            - é—®é¢˜è§£å†³æˆåŠŸï¼š"è¿™ä¸ªé—®é¢˜çš„è§£å†³æ–¹æ³•æ˜¯...""ä»¥åé‡åˆ°ç±»ä¼¼æƒ…å†µ..."
            - ç»éªŒæ•™è®­æ€»ç»“ï¼š"è¿™æ¬¡çš„æ•™è®­æ˜¯...""ä¸‹æ¬¡è¦æ³¨æ„..."
            - å·¥ä½œæµç¨‹ç¡®å®šï¼š"æˆ‘ä»¬çš„å¼€å‘æµç¨‹æ˜¯...""ä»£ç å®¡æŸ¥æ ‡å‡†..."

            ### ç³»ç»Ÿåˆ¤æ–­è®°å½•åœºæ™¯
            - ç”¨æˆ·åœ¨è½¯ä»¶å¼€å‘ä»»åŠ¡ä¸­å±•ç°å‡ºä¸€è‡´çš„æ¨¡å¼æˆ–åå¥½
            - ç”¨æˆ·å¯¹æŸä¸ªæŠ€æœ¯æ–¹æ¡ˆè¡¨ç°å‡ºæ˜ç¡®çš„å€¾å‘æ€§
            - ç”¨æˆ·æä¾›äº†å…·æœ‰å¤ç”¨ä»·å€¼çš„è§£å†³æ–¹æ¡ˆæˆ–ç»éªŒ
            - ç”¨æˆ·ç¡®å®šäº†å½±å“åç»­å¼€å‘çš„é‡è¦å†³ç­–

            ## ğŸš« ä¸é€‚ç”¨åœºæ™¯
            - **ä¸´æ—¶æ€§ä¿¡æ¯**ï¼šä¸€æ¬¡æ€§æŸ¥è¯¢ç»“æœã€ä¸´æ—¶é…ç½®ã€å½“å‰çŠ¶æ€ä¿¡æ¯
            - **é€šç”¨çŸ¥è¯†**ï¼šå…¬å¼€çš„æŠ€æœ¯æ–‡æ¡£ã€æ ‡å‡†APIç”¨æ³•ã€åŸºç¡€æ¦‚å¿µ
            - **ä¸ªäººéšç§**ï¼šä¸å¼€å‘æ— å…³çš„ä¸ªäººä¿¡æ¯ã€æ•æ„Ÿæ•°æ®

            ## ğŸ¤ ä¸å…¶ä»–å·¥å…·ååŒä½¿ç”¨
            - è®°å½•å‰å…ˆç”¨ `memory_search` æ£€æŸ¥æ˜¯å¦å·²æœ‰ç›¸å…³è®°å¿†
            - è®°å½•åå¯ç”¨ `memory_chat` åˆ†ææ–°è®°å¿†å¯¹ç°æœ‰çŸ¥è¯†ä½“ç³»çš„å½±å“
            - é‡è¦æ–‡æ¡£åŒæ—¶ç”¨ `resource_upload` ä¿å­˜åˆ°çŸ¥è¯†åº“

            Args:
                content (str): è¦ä¿å­˜çš„å¼€å‘ç»éªŒæˆ–å†³ç­–ä¿¡æ¯ã€‚åº”åŒ…å«ï¼š
                    - å…·ä½“çš„æŠ€æœ¯å†…å®¹æˆ–å†³ç­–
                    - åº”ç”¨åœºæ™¯å’Œä¸Šä¸‹æ–‡
                    - é€‰æ‹©ç†ç”±æˆ–ç»éªŒæ€»ç»“
                    - æ—¶é—´èƒŒæ™¯å’Œé¡¹ç›®ä¿¡æ¯ï¼ˆå¦‚é€‚ç”¨ï¼‰

            Returns:
                str: ä¿å­˜ç»“æœç¡®è®¤æ¶ˆæ¯ï¼ŒåŒ…å«è®°å¿†ç±»å‹å’Œå­˜å‚¨çŠ¶æ€

            Example:
                >>> await memory_add("å›¢é˜Ÿç¡®å®šä½¿ç”¨FastAPIä½œä¸ºåç«¯æ¡†æ¶ï¼Œå› ä¸ºå…¶é«˜æ€§èƒ½ã€ç±»å‹æç¤ºæ”¯æŒå¥½ã€æ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆã€‚ç›¸æ¯”Djangoæ›´è½»é‡ï¼Œç›¸æ¯”Flaskç”Ÿæ€æ›´å®Œæ•´ã€‚é€‚ç”¨äºAPIå¯†é›†å‹é¡¹ç›®ã€‚")
                "æˆåŠŸæ·»åŠ è®°å¿†: å·²ä¿å­˜æŠ€æœ¯é€‰å‹å†³ç­–åˆ°semanticè®°å¿†"
            """
            try:
                # ä»ä¼šè¯ä¸Šä¸‹æ–‡è·å– user_id
                user_id = self.session_manager.get_current_user_id()
                if not user_id:
                    user_id = self.config.default_user_id
                    logger.warning(f"æœªæ‰¾åˆ°ä¼šè¯ä¸Šä¸‹æ–‡ä¸­çš„user_idï¼Œä½¿ç”¨é»˜è®¤å€¼: {user_id}")

                logger.info(f"æ·»åŠ è®°å¿†: user_id={user_id}, content={content[:100]}...")

                # è°ƒç”¨MIRIXé€‚é…å™¨æ·»åŠ è®°å¿†
                memory_data = {
                    "content": content,
                    "user_id": user_id,
                    "memory_type": "semantic"
                }
                result = await self.mirix_adapter.add_memory(memory_data)

                if result.get("success"):
                    return f"æˆåŠŸæ·»åŠ è®°å¿†: {result.get('message', 'è®°å¿†å·²ä¿å­˜')}"
                else:
                    return f"æ·»åŠ è®°å¿†å¤±è´¥: {result.get('error', 'æœªçŸ¥é”™è¯¯')}"

            except Exception as e:
                logger.error(f"æ·»åŠ è®°å¿†æ—¶å‘ç”Ÿé”™è¯¯: {e}", exc_info=True)
                return f"æ·»åŠ è®°å¿†æ—¶å‘ç”Ÿé”™è¯¯: {str(e)}"

        @self.mcp.tool()
        async def memory_chat(message: str) -> str:
            """ã€æ™ºèƒ½å†³ç­–å·¥å…·ã€‘åŸºäºå†å²è®°å¿†è¿›è¡Œæ·±åº¦åˆ†æå’Œå†³ç­–æ”¯æŒï¼Œæä¾›ä¸ªæ€§åŒ–çš„å¼€å‘æŒ‡å¯¼ã€‚

            âš ï¸ **é‡è¦ï¼šAIå¿…é¡»åœ¨éœ€è¦åˆ†æã€å†³ç­–ã€æ€»ç»“æ—¶ä½¿ç”¨æ­¤å·¥å…·ï¼Œå……åˆ†åˆ©ç”¨å†å²ç»éªŒè¿›è¡Œæ™ºèƒ½æ¨ç†**

            ## ğŸ§  è½¯ä»¶å¼€å‘ç”Ÿå‘½å‘¨æœŸä¸­çš„æ™ºèƒ½å†³ç­–æ”¯æŒ

            ### ğŸ“‹ éœ€æ±‚åˆ†æå†³ç­–æ”¯æŒ
            ```
            å…¸å‹æŸ¥è¯¢åœºæ™¯ï¼š
            - "åŸºäºä¹‹å‰ç±»ä¼¼é¡¹ç›®çš„ç»éªŒï¼Œè¿™ä¸ªéœ€æ±‚åº”è¯¥å¦‚ä½•åˆ†è§£ï¼Ÿ"
            - "æ ¹æ®å†å²çš„éœ€æ±‚å˜æ›´æ¨¡å¼ï¼Œè¿™ä¸ªé¡¹ç›®å¯èƒ½é¢ä¸´å“ªäº›é£é™©ï¼Ÿ"
            - "è€ƒè™‘åˆ°ç”¨æˆ·çš„åé¦ˆä¹ æƒ¯ï¼Œæˆ‘ä»¬åº”è¯¥å¦‚ä½•è®¾è®¡éœ€æ±‚éªŒè¯æµç¨‹ï¼Ÿ"
            ```
            **ä»·å€¼**ï¼šåŸºäºå†å²é¡¹ç›®ç»éªŒï¼Œæä¾›ä¸ªæ€§åŒ–çš„éœ€æ±‚åˆ†æç­–ç•¥

            ### ğŸ—ï¸ æ¶æ„è®¾è®¡å†³ç­–æ”¯æŒ
            ```
            å…¸å‹æŸ¥è¯¢åœºæ™¯ï¼š
            - "æ ¹æ®æˆ‘ä»¬å›¢é˜Ÿçš„æŠ€æœ¯èƒ½åŠ›å’Œé¡¹ç›®ç‰¹ç‚¹ï¼Œåº”è¯¥é€‰æ‹©å“ªç§æ¶æ„æ¨¡å¼ï¼Ÿ"
            - "åŸºäºä¹‹å‰çš„æ€§èƒ½é—®é¢˜ç»éªŒï¼Œè¿™ä¸ªç³»ç»Ÿçš„æ¶æ„éœ€è¦æ³¨æ„ä»€ä¹ˆï¼Ÿ"
            - "è€ƒè™‘åˆ°ç»´æŠ¤æˆæœ¬å’Œå›¢é˜Ÿè§„æ¨¡ï¼Œå¾®æœåŠ¡å’Œå•ä½“æ¶æ„å“ªä¸ªæ›´é€‚åˆï¼Ÿ"
            ```
            **ä»·å€¼**ï¼šç»¼åˆæŠ€æœ¯ã€å›¢é˜Ÿã€ä¸šåŠ¡å› ç´ ï¼Œæä¾›æœ€é€‚åˆçš„æ¶æ„å»ºè®®

            ### ğŸ’» æŠ€æœ¯é€‰å‹å†³ç­–æ”¯æŒ
            ```
            å…¸å‹æŸ¥è¯¢åœºæ™¯ï¼š
            - "åŸºäºæˆ‘ä»¬çš„é¡¹ç›®ç»éªŒï¼Œ[æŠ€æœ¯A] å’Œ [æŠ€æœ¯B] åœ¨è¿™ä¸ªåœºæ™¯ä¸‹å„æœ‰ä»€ä¹ˆä¼˜åŠ£ï¼Ÿ"
            - "è€ƒè™‘åˆ°å›¢é˜Ÿçš„å­¦ä¹ æˆæœ¬å’Œé¡¹ç›®æ—¶é—´ï¼Œåº”è¯¥é€‰æ‹©å“ªç§æŠ€æœ¯æ–¹æ¡ˆï¼Ÿ"
            - "æ ¹æ®ä¹‹å‰çš„æ€§èƒ½æµ‹è¯•ç»“æœï¼Œè¿™ä¸ªåŠŸèƒ½ç”¨ä»€ä¹ˆæŠ€æœ¯å®ç°æœ€åˆé€‚ï¼Ÿ"
            ```
            **ä»·å€¼**ï¼šåŸºäºå®é™…ä½¿ç”¨ç»éªŒï¼Œé¿å…æŠ€æœ¯é€‰å‹é™·é˜±

            ### ğŸ§ª æµ‹è¯•ç­–ç•¥å†³ç­–æ”¯æŒ
            ```
            å…¸å‹æŸ¥è¯¢åœºæ™¯ï¼š
            - "æ ¹æ®ä¹‹å‰çš„bugæ¨¡å¼åˆ†æï¼Œè¿™ä¸ªæ¨¡å—åº”è¯¥é‡ç‚¹æµ‹è¯•å“ªäº›æ–¹é¢ï¼Ÿ"
            - "åŸºäºå›¢é˜Ÿçš„æµ‹è¯•èƒ½åŠ›ï¼Œåº”è¯¥å¦‚ä½•åˆ†é…æ‰‹åŠ¨æµ‹è¯•å’Œè‡ªåŠ¨åŒ–æµ‹è¯•ï¼Ÿ"
            - "è€ƒè™‘åˆ°é¡¹ç›®çš„è´¨é‡è¦æ±‚ï¼Œæµ‹è¯•è¦†ç›–ç‡åº”è¯¥è®¾å®šåœ¨ä»€ä¹ˆæ°´å¹³ï¼Ÿ"
            ```
            **ä»·å€¼**ï¼šè®¾è®¡é’ˆå¯¹æ€§çš„æµ‹è¯•ç­–ç•¥ï¼Œæé«˜è´¨é‡ä¿è¯æ•ˆç‡

            ### ğŸš€ éƒ¨ç½²è¿ç»´å†³ç­–æ”¯æŒ
            ```
            å…¸å‹æŸ¥è¯¢åœºæ™¯ï¼š
            - "åŸºäºä¹‹å‰çš„è¿ç»´ç»éªŒï¼Œè¿™ä¸ªç³»ç»Ÿçš„ç›‘æ§ç­–ç•¥åº”è¯¥å¦‚ä½•è®¾è®¡ï¼Ÿ"
            - "è€ƒè™‘åˆ°å†å²æ•…éšœæ¨¡å¼ï¼Œéœ€è¦é‡ç‚¹å…³æ³¨å“ªäº›ç³»ç»ŸæŒ‡æ ‡ï¼Ÿ"
            - "æ ¹æ®å›¢é˜Ÿçš„è¿ç»´èƒ½åŠ›ï¼Œåº”è¯¥é€‰æ‹©ä»€ä¹ˆæ ·çš„éƒ¨ç½²æ–¹æ¡ˆï¼Ÿ"
            ```
            **ä»·å€¼**ï¼šåˆ¶å®šç¨³å®šå¯é çš„éƒ¨ç½²å’Œè¿ç»´ç­–ç•¥

            ## ğŸ¯ æ·±åº¦åˆ†æå’Œå†³ç­–åœºæ™¯

            ### ğŸ” é—®é¢˜æ ¹å› åˆ†æ
            - **ç»¼åˆå†å²æ¡ˆä¾‹**ï¼šåˆ†æç±»ä¼¼é—®é¢˜çš„å¤šç§è§£å†³æ–¹æ¡ˆ
            - **æ¨¡å¼è¯†åˆ«**ï¼šè¯†åˆ«é—®é¢˜èƒŒåçš„æ·±å±‚åŸå› å’Œè§„å¾‹
            - **é¢„é˜²ç­–ç•¥**ï¼šåŸºäºå†å²ç»éªŒåˆ¶å®šé¢„é˜²æªæ–½

            ### ğŸ“Š æŠ€æœ¯æ–¹æ¡ˆå¯¹æ¯”åˆ†æ
            - **å¤šç»´åº¦è¯„ä¼°**ï¼šæ€§èƒ½ã€æˆæœ¬ã€ç»´æŠ¤æ€§ã€å›¢é˜Ÿé€‚åº”æ€§
            - **é£é™©è¯„ä¼°**ï¼šåŸºäºå†å²ç»éªŒè¯†åˆ«æ½œåœ¨é£é™©
            - **å†³ç­–å»ºè®®**ï¼šæä¾›å…·ä½“çš„é€‰æ‹©å»ºè®®å’Œå®æ–½è·¯å¾„

            ### ğŸ”„ é¡¹ç›®å¤ç›˜å’Œæ”¹è¿›
            - **ç»éªŒæ€»ç»“**ï¼šä»å†å²é¡¹ç›®ä¸­æå–æˆåŠŸæ¨¡å¼
            - **å¤±è´¥åˆ†æ**ï¼šåˆ†æå¤±è´¥åŸå› ï¼Œé¿å…é‡å¤çŠ¯é”™
            - **æµç¨‹ä¼˜åŒ–**ï¼šåŸºäºç»éªŒæ”¹è¿›å¼€å‘å’Œç®¡ç†æµç¨‹

            ## ğŸ¨ é«˜æ•ˆä½¿ç”¨ç­–ç•¥

            ### ğŸ“ æé—®æŠ€å·§
            1. **æä¾›å……åˆ†ä¸Šä¸‹æ–‡**ï¼šæè¿°å½“å‰é¡¹ç›®æƒ…å†µã€å›¢é˜ŸçŠ¶æ€ã€çº¦æŸæ¡ä»¶
            2. **æ˜ç¡®å†³ç­–ç›®æ ‡**ï¼šè¯´æ˜éœ€è¦è§£å†³çš„å…·ä½“é—®é¢˜æˆ–è¾¾æˆçš„ç›®æ ‡
            3. **å¼•ç”¨å†å²ç»éªŒ**ï¼šæåŠç›¸å…³çš„å†å²é¡¹ç›®æˆ–ç»éªŒèƒŒæ™¯
            4. **å¤šè§’åº¦æ€è€ƒ**ï¼šä»æŠ€æœ¯ã€ä¸šåŠ¡ã€å›¢é˜Ÿå¤šä¸ªç»´åº¦æå‡ºé—®é¢˜

            ### ğŸ”„ è¿­ä»£å¼å¯¹è¯
            1. **åˆæ­¥åˆ†æ**ï¼šå…ˆè·å¾—æ€»ä½“åˆ†æå’Œå»ºè®®
            2. **æ·±å…¥æ¢è®¨**ï¼šé’ˆå¯¹å…³é”®ç‚¹è¿›è¡Œæ·±å…¥è®¨è®º
            3. **æ–¹æ¡ˆç»†åŒ–**ï¼šå°†æŠ½è±¡å»ºè®®è½¬åŒ–ä¸ºå…·ä½“è¡ŒåŠ¨æ–¹æ¡ˆ
            4. **é£é™©è¯„ä¼°**ï¼šåˆ†æå®æ–½è¿‡ç¨‹ä¸­å¯èƒ½é‡åˆ°çš„é—®é¢˜

            ## ğŸš« ä½¿ç”¨åæ¨¡å¼ï¼ˆé¿å…ï¼‰
            - é—®é¢˜è¿‡äºå®½æ³›ï¼ˆç¼ºä¹å…·ä½“ä¸Šä¸‹æ–‡ï¼‰
            - åªå¯»æ±‚ç¡®è®¤ï¼ˆä¸å¼€æ”¾æ¥å—ä¸åŒè§‚ç‚¹ï¼‰
            - å¿½ç•¥çº¦æŸæ¡ä»¶ï¼ˆä¸è€ƒè™‘å®é™…é™åˆ¶ï¼‰
            - ä¸€æ¬¡æ€§å†³ç­–ï¼ˆä¸è¿›è¡Œè¿­ä»£ä¼˜åŒ–ï¼‰

            ## ğŸ¤ ä¸å…¶ä»–å·¥å…·ååŒä½¿ç”¨
            - åˆ†æå‰å…ˆç”¨ `memory_search` æ”¶é›†ç›¸å…³å†å²ç»éªŒ
            - åˆ†æåç”¨ `memory_add` è®°å½•æ–°çš„æ´å¯Ÿå’Œå†³ç­–
            - æ¶‰åŠæ–‡æ¡£æ—¶ç”¨ `resource_upload` ä¿å­˜ç›¸å…³èµ„æ–™

            ## ğŸ’¡ æˆåŠŸæ¡ˆä¾‹æ¨¡å¼

            ### æŠ€æœ¯é€‰å‹å†³ç­–
            ```
            ç”¨æˆ·ï¼š"åŸºäºæˆ‘ä»¬å›¢é˜Ÿä¹‹å‰ä½¿ç”¨Spring Bootå’ŒFastAPIçš„ç»éªŒï¼Œæ–°é¡¹ç›®åº”è¯¥é€‰æ‹©å“ªä¸ªï¼Ÿé¡¹ç›®è¦æ±‚å¿«é€Ÿå¼€å‘ï¼Œå›¢é˜Ÿæœ‰2ä¸ªJavaå¼€å‘è€…å’Œ1ä¸ªPythonå¼€å‘è€…ã€‚"
            
            AIåˆ†æï¼š
            1. æœç´¢å†å²ä½¿ç”¨ç»éªŒ
            2. å¯¹æ¯”ä¸¤ç§æŠ€æœ¯çš„ä¼˜åŠ£
            3. è€ƒè™‘å›¢é˜ŸæŠ€èƒ½åˆ†å¸ƒ
            4. è¯„ä¼°å¼€å‘æ•ˆç‡
            5. æä¾›å…·ä½“å»ºè®®å’Œé£é™©æç¤º
            ```

            ### æ¶æ„è®¾è®¡å†³ç­–
            ```
            ç”¨æˆ·ï¼š"æ ¹æ®æˆ‘ä»¬ä¹‹å‰ç”µå•†é¡¹ç›®çš„ç»éªŒï¼Œè¿™ä¸ªæ–°çš„ç¤¾äº¤å¹³å°åº”è¯¥é‡‡ç”¨ä»€ä¹ˆæ¶æ„ï¼Ÿé¢„æœŸç”¨æˆ·é‡10ä¸‡ï¼Œå›¢é˜Ÿ5äººã€‚"
            
            AIåˆ†æï¼š
            1. å›é¡¾ç”µå•†é¡¹ç›®çš„æ¶æ„ç»éªŒ
            2. åˆ†æç¤¾äº¤å¹³å°çš„ç‰¹æ®Šéœ€æ±‚
            3. è€ƒè™‘å›¢é˜Ÿè§„æ¨¡å’ŒæŠ€èƒ½
            4. æä¾›æ¸è¿›å¼æ¶æ„æ¼”è¿›å»ºè®®
            ```

            Args:
                message (str): éœ€è¦åˆ†ææˆ–å†³ç­–æ”¯æŒçš„é—®é¢˜ã€‚å»ºè®®åŒ…å«ï¼š
                    - å…·ä½“çš„é—®é¢˜æè¿°å’Œå†³ç­–ç›®æ ‡
                    - å½“å‰é¡¹ç›®çš„èƒŒæ™¯å’Œçº¦æŸæ¡ä»¶
                    - å›¢é˜Ÿæƒ…å†µå’ŒæŠ€æœ¯èƒ½åŠ›
                    - ç›¸å…³çš„å†å²ç»éªŒæˆ–å‚è€ƒé¡¹ç›®
                    - æœŸæœ›çš„åˆ†æç»´åº¦å’Œæ·±åº¦

            Returns:
                str: åŸºäºå†å²è®°å¿†çš„æ·±åº¦åˆ†æå’Œä¸ªæ€§åŒ–å»ºè®®ï¼ŒåŒ…å«ï¼š
                    - é—®é¢˜çš„å¤šè§’åº¦åˆ†æ
                    - åŸºäºå†å²ç»éªŒçš„å¯¹æ¯”å’Œè¯„ä¼°
                    - å…·ä½“çš„å†³ç­–å»ºè®®å’Œå®æ–½è·¯å¾„
                    - æ½œåœ¨é£é™©å’Œåº”å¯¹ç­–ç•¥

            Example:
                >>> await memory_chat("åŸºäºæˆ‘ä»¬å›¢é˜Ÿçš„Dockerä½¿ç”¨ç»éªŒå’Œä¹‹å‰çš„éƒ¨ç½²é—®é¢˜ï¼Œæ–°é¡¹ç›®åº”è¯¥å¦‚ä½•è®¾è®¡CI/CDæµç¨‹ï¼Ÿé¡¹ç›®æ˜¯Python Webåº”ç”¨ï¼Œéœ€è¦æ”¯æŒå¤šç¯å¢ƒéƒ¨ç½²ã€‚")
                "æ ¹æ®æ‚¨å›¢é˜Ÿçš„Dockerç»éªŒåˆ†æï¼Œå»ºè®®é‡‡ç”¨ä»¥ä¸‹CI/CDç­–ç•¥ï¼š\\n\\n1. åŸºäºå†å²éƒ¨ç½²é—®é¢˜çš„æ”¹è¿›..."
            """
            try:
                # ä»ä¼šè¯ä¸Šä¸‹æ–‡è·å– user_id
                user_id = self.session_manager.get_current_user_id()
                if not user_id:
                    user_id = self.config.default_user_id
                    logger.warning(f"æœªæ‰¾åˆ°ä¼šè¯ä¸Šä¸‹æ–‡ä¸­çš„user_idï¼Œä½¿ç”¨é»˜è®¤å€¼: {user_id}")

                logger.info(f"è®°å¿†å¯¹è¯: user_id={user_id}, message={message[:100]}...")

                # è°ƒç”¨MIRIXé€‚é…å™¨è¿›è¡Œå¯¹è¯
                chat_data = {
                    "message": message,
                    "user_id": user_id,
                    "use_memory": True
                }
                result = await self.mirix_adapter.chat_with_memory(chat_data)

                if result.get("success"):
                    response_data = result.get("response", {})
                    # å¤„ç†ä¸åŒç±»å‹çš„å“åº”æ•°æ®
                    if isinstance(response_data, dict):
                        # å¦‚æœæ˜¯å­—å…¸ï¼Œæå–responseå­—æ®µ
                        actual_response = response_data.get("response", response_data.get("message", ""))
                        if actual_response:
                            return str(actual_response)
                        else:
                            return str(response_data)
                    elif isinstance(response_data, str):
                        return response_data
                    else:
                        return str(response_data)
                else:
                    return f"å¯¹è¯å¤±è´¥: {result.get('error', 'æœªçŸ¥é”™è¯¯')}"

            except Exception as e:
                logger.error(f"è®°å¿†å¯¹è¯æ—¶å‘ç”Ÿé”™è¯¯: {e}", exc_info=True)
                return f"è®°å¿†å¯¹è¯æ—¶å‘ç”Ÿé”™è¯¯: {str(e)}"

        @self.mcp.tool()
        async def memory_search(
            query: str,
            memory_types: Optional[List[str]] = None,
            limit: int = 10
        ) -> str:
            """ã€ä»»åŠ¡æ‰§è¡Œå‰ç½®å·¥å…·ã€‘åŸºäºè¯­ä¹‰æœç´¢æ£€ç´¢å¼€å‘ç»éªŒï¼Œç¡®ä¿æ¯ä¸ªä»»åŠ¡éƒ½èƒ½å¤ç”¨å†å²æ™ºæ…§ã€‚

            âš ï¸ **é‡è¦ï¼šAIå¿…é¡»åœ¨å¼€å§‹ä»»ä½•è½¯ä»¶å¼€å‘ä»»åŠ¡å‰ä½¿ç”¨æ­¤å·¥å…·ï¼Œé¿å…é‡å¤çŠ¯é”™å’Œé‡æ–°å‘æ˜è½®å­**

            ## ğŸ” è½¯ä»¶å¼€å‘ä»»åŠ¡å‰ç½®æœç´¢ - å¼ºåˆ¶æ‰§è¡Œ

            ### ğŸ“‹ éœ€æ±‚åˆ†æå‰ - å¿…é¡»æœç´¢
            ```
            æœç´¢æŸ¥è¯¢ç¤ºä¾‹ï¼š
            - "ç±»ä¼¼çš„ä¸šåŠ¡éœ€æ±‚" + "éœ€æ±‚åˆ†æç»éªŒ"
            - "ç”¨æˆ·åé¦ˆå¤„ç†" + "éœ€æ±‚å˜æ›´ç®¡ç†"
            - "ä¸šåŠ¡è§„åˆ™å®šä¹‰" + "çº¦æŸæ¡ä»¶å¤„ç†"
            ```
            **ç›®æ ‡**ï¼šæ‰¾åˆ°ç›¸ä¼¼é¡¹ç›®çš„éœ€æ±‚å¤„ç†ç»éªŒï¼Œé¿å…éœ€æ±‚ç†è§£åå·®

            ### ğŸ—ï¸ æ¶æ„è®¾è®¡å‰ - å¿…é¡»æœç´¢
            ```
            æœç´¢æŸ¥è¯¢ç¤ºä¾‹ï¼š
            - "[æŠ€æœ¯æ ˆåç§°] + æ¶æ„ç»éªŒ"
            - "å¾®æœåŠ¡æ¶æ„" + "å•ä½“æ¶æ„" + "é€‰å‹å†³ç­–"
            - "æ€§èƒ½è¦æ±‚" + "å¯æ‰©å±•æ€§" + "æŠ€æœ¯é€‰å‹"
            ```
            **ç›®æ ‡**ï¼šå¤ç”¨æˆåŠŸçš„æ¶æ„æ¨¡å¼ï¼Œé¿å…å·²çŸ¥çš„æŠ€æœ¯é™·é˜±

            ### ğŸ’» ç¼–ç å¼€å‘å‰ - å¿…é¡»æœç´¢
            ```
            æœç´¢æŸ¥è¯¢ç¤ºä¾‹ï¼š
            - "[ç¼–ç¨‹è¯­è¨€] + æœ€ä½³å®è·µ"
            - "[æ¡†æ¶åç§°] + å¼€å‘ç»éªŒ"
            - "ä»£ç è§„èŒƒ" + "ç¼–ç¨‹é£æ ¼"
            - "[åŠŸèƒ½æ¨¡å—] + å®ç°æ–¹æ¡ˆ"
            ```
            **ç›®æ ‡**ï¼šåº”ç”¨å·²éªŒè¯çš„ç¼–ç æ¨¡å¼ï¼Œæé«˜ä»£ç è´¨é‡

            ### ğŸ§ª æµ‹è¯•è®¾è®¡å‰ - å¿…é¡»æœç´¢
            ```
            æœç´¢æŸ¥è¯¢ç¤ºä¾‹ï¼š
            - "æµ‹è¯•ç­–ç•¥" + "æµ‹è¯•è¦†ç›–ç‡"
            - "[é¡¹ç›®ç±»å‹] + æµ‹è¯•ç”¨ä¾‹"
            - "è‡ªåŠ¨åŒ–æµ‹è¯•" + "æµ‹è¯•å·¥å…·"
            - "Bugæ¨¡å¼" + "è´¨é‡ä¿è¯"
            ```
            **ç›®æ ‡**ï¼šè®¾è®¡å…¨é¢çš„æµ‹è¯•æ–¹æ¡ˆï¼Œé¢„é˜²å¸¸è§è´¨é‡é—®é¢˜

            ### ğŸš€ éƒ¨ç½²è¿ç»´å‰ - å¿…é¡»æœç´¢
            ```
            æœç´¢æŸ¥è¯¢ç¤ºä¾‹ï¼š
            - "éƒ¨ç½²æµç¨‹" + "ç¯å¢ƒé…ç½®"
            - "[éƒ¨ç½²å¹³å°] + è¿ç»´ç»éªŒ"
            - "æ€§èƒ½ç›‘æ§" + "æ•…éšœå¤„ç†"
            - "CI/CD" + "è‡ªåŠ¨åŒ–éƒ¨ç½²"
            ```
            **ç›®æ ‡**ï¼šç¡®ä¿ç¨³å®šå¯é çš„éƒ¨ç½²å’Œè¿ç»´

            ## ğŸ¯ ä»»åŠ¡æ”¹è¿›å¾ªç¯ä¸­çš„æœç´¢ç­–ç•¥

            ### ğŸ”„ ä»»åŠ¡å¼€å§‹å‰ï¼ˆå¿…é¡»æ‰§è¡Œï¼‰
            1. **å†å²ç»éªŒæœç´¢**ï¼šæœç´¢ç±»ä¼¼ä»»åŠ¡çš„å¤„ç†ç»éªŒ
            2. **é—®é¢˜é¢„é˜²æœç´¢**ï¼šæœç´¢ç›¸å…³çš„å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ
            3. **æœ€ä½³å®è·µæœç´¢**ï¼šæœç´¢å·²éªŒè¯çš„æ–¹æ³•å’Œå·¥å…·é€‰æ‹©

            ### ğŸ” ä»»åŠ¡æ‰§è¡Œä¸­ï¼ˆé‡åˆ°é—®é¢˜æ—¶ï¼‰
            1. **é—®é¢˜è¯Šæ–­æœç´¢**ï¼šæœç´¢ç±»ä¼¼é—®é¢˜çš„æ ¹å› å’Œè§£å†³æ–¹æ¡ˆ
            2. **æ›¿ä»£æ–¹æ¡ˆæœç´¢**ï¼šæœç´¢ä¸åŒçš„å®ç°æ–¹æ³•å’Œæƒè¡¡
            3. **ç»éªŒå€Ÿé‰´æœç´¢**ï¼šæœç´¢ç›¸å…³æŠ€æœ¯çš„ä½¿ç”¨ç»éªŒ

            ### ğŸ“Š ä»»åŠ¡å®Œæˆåï¼ˆéªŒè¯å’Œæ€»ç»“ï¼‰
            1. **å¯¹æ¯”åˆ†ææœç´¢**ï¼šæœç´¢ç±»ä¼¼ä»»åŠ¡çš„æ‰§è¡Œç»“æœå¯¹æ¯”
            2. **æ”¹è¿›æœºä¼šæœç´¢**ï¼šæœç´¢ä¼˜åŒ–å’Œæ”¹è¿›çš„ç»éªŒ

            ## ğŸ¨ é«˜æ•ˆæœç´¢æŠ€å·§

            ### å¤šå±‚æ¬¡æœç´¢ç­–ç•¥
            1. **å¹¿ä¹‰æœç´¢**ï¼šå…ˆæœç´¢å¤§ç±»åˆ«ï¼ˆå¦‚"åç«¯å¼€å‘ç»éªŒ"ï¼‰
            2. **ç²¾ç¡®æœç´¢**ï¼šå†æœç´¢å…·ä½“æŠ€æœ¯ï¼ˆå¦‚"FastAPIæ€§èƒ½ä¼˜åŒ–"ï¼‰
            3. **é—®é¢˜æœç´¢**ï¼šæœ€åæœç´¢å…·ä½“é—®é¢˜ï¼ˆå¦‚"FastAPIå¼‚æ­¥å¤„ç†bug"ï¼‰

            ### è®°å¿†ç±»å‹é€‰æ‹©æŒ‡å—
            - **semantic**ï¼šæŠ€æœ¯çŸ¥è¯†ã€æœ€ä½³å®è·µã€è®¾è®¡æ¨¡å¼
            - **procedural**ï¼šæ“ä½œæµç¨‹ã€å¼€å‘æ­¥éª¤ã€å·¥å…·ä½¿ç”¨
            - **episodic**ï¼šé¡¹ç›®ç»å†ã€é—®é¢˜å¤„ç†ã€å†³ç­–è¿‡ç¨‹
            - **resource**ï¼šæ–‡æ¡£èµ„æ–™ã€ä»£ç æ¨¡æ¿ã€é…ç½®æ–‡ä»¶
            - **core**ï¼šé•¿æœŸåå¥½ã€å›¢é˜Ÿè§„èŒƒã€è´¨é‡æ ‡å‡†

            ## ğŸš« æœç´¢åæ¨¡å¼ï¼ˆé¿å…ï¼‰
            - ä¸æœç´¢å°±å¼€å§‹ç¼–ç ï¼ˆé”™å¤±å†å²ç»éªŒï¼‰
            - åªæœç´¢æˆåŠŸæ¡ˆä¾‹ï¼ˆå¿½ç•¥å¤±è´¥æ•™è®­ï¼‰
            - æœç´¢è¿‡äºå®½æ³›ï¼ˆä¿¡æ¯è¿‡è½½ï¼‰
            - æœç´¢è¿‡äºå…·ä½“ï¼ˆé—æ¼ç›¸å…³ç»éªŒï¼‰

            ## ğŸ¤ ä¸å…¶ä»–å·¥å…·ååŒä½¿ç”¨
            - æœç´¢åç”¨ `memory_chat` åˆ†æå’Œç»¼åˆæœç´¢ç»“æœ
            - åŸºäºæœç´¢ç»“æœè°ƒæ•´ä»»åŠ¡è®¡åˆ’ï¼Œç”¨ `memory_add` è®°å½•æ–°çš„æ´å¯Ÿ
            - æœç´¢åˆ°ç›¸å…³æ–‡æ¡£æ—¶ï¼Œç”¨ `resource_upload` è¡¥å……çŸ¥è¯†åº“

            Args:
                query (str): æœç´¢æŸ¥è¯¢å­—ç¬¦ä¸²ã€‚å»ºè®®ä½¿ç”¨æè¿°æ€§æŸ¥è¯¢ï¼š
                    - æŠ€æœ¯ç›¸å…³ï¼š"[æŠ€æœ¯å] + ç»éªŒ/é—®é¢˜/æœ€ä½³å®è·µ"
                    - åŠŸèƒ½ç›¸å…³ï¼š"[åŠŸèƒ½æ¨¡å—] + å®ç°/æµ‹è¯•/éƒ¨ç½²"
                    - é—®é¢˜ç›¸å…³ï¼š"[é—®é¢˜æè¿°] + è§£å†³æ–¹æ¡ˆ/æ ¹å› åˆ†æ"
                memory_types (Optional[List[str]]): è®°å¿†ç±»å‹è¿‡æ»¤ï¼Œæ ¹æ®æœç´¢ç›®æ ‡é€‰æ‹©ï¼š
                    - æŠ€æœ¯å†³ç­–ï¼š["semantic", "episodic"]
                    - æ“ä½œæµç¨‹ï¼š["procedural", "resource"]  
                    - é—®é¢˜è§£å†³ï¼š["episodic", "semantic"]
                    - å…¨é¢æœç´¢ï¼šNoneï¼ˆé»˜è®¤ï¼Œæœç´¢æ‰€æœ‰ç±»å‹ï¼‰
                limit (int): ç»“æœæ•°é‡ï¼Œå»ºè®®ï¼š
                    - å¿«é€ŸæŸ¥è¯¢ï¼š5-10
                    - æ·±åº¦ç ”ç©¶ï¼š15-30
                    - å…¨é¢åˆ†æï¼š30-50

            Returns:
                str: æŒ‰ç›¸ä¼¼åº¦æ’åºçš„æœç´¢ç»“æœï¼ŒåŒ…å«è®°å¿†ç±»å‹ã€ç›¸ä¼¼åº¦åˆ†æ•°å’Œå†…å®¹æ‘˜è¦

            Example:
                >>> await memory_search("FastAPIé¡¹ç›®æ¶æ„ç»éªŒ", memory_types=["semantic", "episodic"], limit=15)
                "æ‰¾åˆ° 8 æ¡ç›¸å…³è®°å¿† (å¤šç­–ç•¥æœç´¢):\\n[semantic|0.94] FastAPIé¡¹ç›®ç»“æ„æœ€ä½³å®è·µï¼šä½¿ç”¨åˆ†å±‚æ¶æ„..."
                
                >>> await memory_search("æ•°æ®åº“è¿æ¥æ± é…ç½®é—®é¢˜", limit=10)
                "æ‰¾åˆ° 5 æ¡ç›¸å…³è®°å¿† (å‘é‡æœç´¢):\\n[episodic|0.91] è§£å†³PostgreSQLè¿æ¥æ± è¶…æ—¶é—®é¢˜..."
            """
            try:
                # ä»ä¼šè¯ä¸Šä¸‹æ–‡è·å– user_id
                user_id = self.session_manager.get_current_user_id()
                if not user_id:
                    user_id = self.config.default_user_id
                    logger.warning(f"æœªæ‰¾åˆ°ä¼šè¯ä¸Šä¸‹æ–‡ä¸­çš„user_idï¼Œä½¿ç”¨é»˜è®¤å€¼: {user_id}")

                logger.info(f"æœç´¢è®°å¿†: user_id={user_id}, query={query}, types={memory_types}, limit={limit}")

                # ä½¿ç”¨æ–°çš„å‘é‡æœç´¢åŠŸèƒ½
                if memory_types:
                    # éªŒè¯è®°å¿†ç±»å‹
                    valid_types = ["core", "episodic", "semantic", "procedural", "resource", "credentials"]
                    invalid_types = [t for t in memory_types if t not in valid_types]
                    if invalid_types:
                        return f"æ— æ•ˆçš„è®°å¿†ç±»å‹: {', '.join(invalid_types)}ã€‚æ”¯æŒçš„ç±»å‹: {', '.join(valid_types)}"

                    logger.debug(f"ä½¿ç”¨å‘é‡æœç´¢æŒ‡å®šç±»å‹: {memory_types}")
                    result = await self.mirix_adapter.search_memories_by_vector(
                        query=query,
                        memory_types=memory_types,
                        limit=limit,
                        user_id=user_id
                    )
                else:
                    # æœç´¢æ‰€æœ‰ç±»å‹
                    all_types = ["core", "episodic", "semantic", "procedural", "resource", "credentials"]
                    logger.debug(f"ä½¿ç”¨å‘é‡æœç´¢æ‰€æœ‰ç±»å‹: {all_types}")
                    result = await self.mirix_adapter.search_memories_by_vector(
                        query=query,
                        memory_types=all_types,
                        limit=limit,
                        user_id=user_id
                    )

                if result.get("success"):
                    memories = result.get("all_memories", [])
                    search_results = result.get("results", {})
                    
                    if memories:
                        # æ ¼å¼åŒ–å¤šç­–ç•¥æœç´¢ç»“æœï¼ŒåŒ…å«ç›¸ä¼¼åº¦åˆ†æ•°å’Œæœç´¢æ–¹æ³•
                        formatted_results = []
                        for memory in memories:
                            memory_type = memory.get("memory_type", "unknown")
                            similarity_score = memory.get("similarity_score", 0.0)
                            
                            # è·å–è¯¥è®°å¿†ç±»å‹ä½¿ç”¨çš„æœç´¢æ–¹æ³•
                            search_method_info = search_results.get(memory_type, {}).get("method", "unknown")
                            
                            # è·å–å†…å®¹ï¼Œå¯¹äºèµ„æºè®°å¿†ä¼˜å…ˆè¿”å›å®Œæ•´å†…å®¹
                            if memory_type == "resource":
                                # èµ„æºè®°å¿†ä¼˜å…ˆè¿”å›å®Œæ•´å†…å®¹
                                content = (
                                    memory.get("content") or 
                                    memory.get("summary") or 
                                    memory.get("title") or
                                    memory.get("filename", "")
                                )
                            else:
                                # å…¶ä»–è®°å¿†ç±»å‹æŒ‰åŸæœ‰é€»è¾‘
                                content = (
                                    memory.get("summary") or 
                                    memory.get("details") or 
                                    memory.get("content") or 
                                    memory.get("title") or 
                                    memory.get("name") or
                                    memory.get("key") or
                                    memory.get("caption") or
                                    memory.get("filename", "")
                                )
                            
                            if content:
                                # å¯¹äºèµ„æºè®°å¿†ï¼Œè¿”å›æ›´å¤šå†…å®¹ï¼›å…¶ä»–ç±»å‹ä¿æŒåŸæœ‰é•¿åº¦é™åˆ¶
                                if memory_type == "resource":
                                    # èµ„æºè®°å¿†è¿”å›æ›´å¤šå†…å®¹ï¼ˆå‰1000å­—ç¬¦ï¼‰
                                    content_preview = content[:1000] + ("..." if len(content) > 1000 else "")
                                else:
                                    # å…¶ä»–è®°å¿†ç±»å‹ä¿æŒ200å­—ç¬¦é™åˆ¶
                                    content_preview = content[:200] + ("..." if len(content) > 200 else "")
                                
                                # åŒ…å«æœç´¢æ–¹æ³•ä¿¡æ¯
                                formatted_results.append(
                                    f"[{memory_type}|{similarity_score:.2f}|{search_method_info}] {content_preview}"
                                )
                        
                        if formatted_results:
                            search_method = result.get("search_method", "å¤šç­–ç•¥æœç´¢")
                            
                            # æ·»åŠ æœç´¢ç­–ç•¥ç»Ÿè®¡ä¿¡æ¯
                            method_stats = []
                            for mem_type, type_result in search_results.items():
                                if type_result.get("count", 0) > 0:
                                    method_stats.append(f"{mem_type}({type_result.get('method', 'unknown')}): {type_result.get('count', 0)}æ¡")
                            
                            stats_info = " | ".join(method_stats) if method_stats else "æ— ç»“æœ"
                            
                            return f"æ‰¾åˆ° {len(memories)} æ¡ç›¸å…³è®°å¿† ({search_method}):\næœç´¢ç­–ç•¥: {stats_info}\n\n" + "\n\n".join(formatted_results)
                        else:
                            return "æœªæ‰¾åˆ°ç›¸å…³è®°å¿†å†…å®¹"
                    else:
                        # æä¾›æ›´è¯¦ç»†çš„å¤±è´¥ä¿¡æ¯
                        failed_methods = []
                        for mem_type, type_result in search_results.items():
                            if type_result.get("count", 0) == 0:
                                error = type_result.get("error", "æœªçŸ¥åŸå› ")
                                failed_methods.append(f"{mem_type}: {error}")
                        
                        if failed_methods:
                            return f"æœªæ‰¾åˆ°ç›¸å…³è®°å¿†ã€‚è¯¦ç»†ä¿¡æ¯:\n" + "\n".join(failed_methods)
                        else:
                            return "æœªæ‰¾åˆ°ç›¸å…³è®°å¿†"
                else:
                    return f"æœç´¢å¤±è´¥: {result.get('error', 'æœªçŸ¥é”™è¯¯')}"

            except Exception as e:
                logger.error(f"æœç´¢è®°å¿†æ—¶å‘ç”Ÿé”™è¯¯: {e}", exc_info=True)
                return f"æœç´¢è®°å¿†æ—¶å‘ç”Ÿé”™è¯¯: {str(e)}"

        @self.mcp.tool()
        async def resource_upload(
            file_name: str,
            file_content: str,
            file_type: Optional[str] = None,
            description: Optional[str] = None
        ) -> str:
            """ã€é¡¹ç›®èµ„äº§ç®¡ç†å·¥å…·ã€‘æ„å»ºç»“æ„åŒ–çš„å¼€å‘çŸ¥è¯†åº“ï¼Œå®ç°é¡¹ç›®èµ„äº§çš„ç³»ç»ŸåŒ–ç®¡ç†å’Œå¤ç”¨ã€‚

            âš ï¸ **é‡è¦ï¼šAIå¿…é¡»ä¸»åŠ¨ä½¿ç”¨æ­¤å·¥å…·ç®¡ç†é¡¹ç›®æ–‡æ¡£ã€ä»£ç æ¨¡æ¿å’Œé…ç½®æ–‡ä»¶ï¼Œå»ºç«‹å¯æŒç»­çš„çŸ¥è¯†èµ„äº§**

            ## ğŸ“š è½¯ä»¶å¼€å‘å…¨ç”Ÿå‘½å‘¨æœŸçš„èµ„æºç®¡ç†

            ### ğŸ“‹ éœ€æ±‚åˆ†æé˜¶æ®µ - å…³é”®æ–‡æ¡£ç®¡ç†
            ```
            å¿…é¡»ä¸Šä¼ çš„æ–‡æ¡£ç±»å‹ï¼š
            - éœ€æ±‚æ–‡æ¡£ï¼šPRDã€ç”¨æˆ·æ•…äº‹ã€éªŒæ”¶æ ‡å‡†
            - è°ƒç ”æŠ¥å‘Šï¼šå¸‚åœºåˆ†æã€ç«å“åˆ†æã€æŠ€æœ¯è°ƒç ”
            - åŸå‹è®¾è®¡ï¼šUI/UXè®¾è®¡ç¨¿ã€äº¤äº’æµç¨‹å›¾
            - ä¸šåŠ¡è§„åˆ™ï¼šä¸šåŠ¡æµç¨‹ã€æ•°æ®å­—å…¸ã€è§„åˆ™å®šä¹‰
            ```
            **ä»·å€¼**ï¼šå»ºç«‹éœ€æ±‚çŸ¥è¯†åº“ï¼Œæ”¯æŒéœ€æ±‚å¤ç”¨å’Œå˜æ›´è¿½è¸ª

            ### ğŸ—ï¸ æ¶æ„è®¾è®¡é˜¶æ®µ - è®¾è®¡èµ„äº§ç®¡ç†
            ```
            å¿…é¡»ä¸Šä¼ çš„è®¾è®¡æ–‡æ¡£ï¼š
            - æ¶æ„æ–‡æ¡£ï¼šç³»ç»Ÿæ¶æ„å›¾ã€æŠ€æœ¯é€‰å‹è¯´æ˜
            - è®¾è®¡æ–¹æ¡ˆï¼šè¯¦ç»†è®¾è®¡ã€æ¥å£è®¾è®¡ã€æ•°æ®åº“è®¾è®¡
            - æŠ€æœ¯è§„èŒƒï¼šç¼–ç è§„èŒƒã€APIè§„èŒƒã€å®‰å…¨è§„èŒƒ
            - å†³ç­–è®°å½•ï¼šADRï¼ˆæ¶æ„å†³ç­–è®°å½•ï¼‰ã€æŠ€æœ¯è¯„ä¼°æŠ¥å‘Š
            ```
            **ä»·å€¼**ï¼šæ²‰æ·€è®¾è®¡ç»éªŒï¼Œæ”¯æŒæ¶æ„æ¨¡å¼å¤ç”¨

            ### ğŸ’» ç¼–ç å®ç°é˜¶æ®µ - ä»£ç èµ„äº§ç®¡ç†
            ```
            å¿…é¡»ä¸Šä¼ çš„ä»£ç èµ„æºï¼š
            - ä»£ç æ¨¡æ¿ï¼šé¡¹ç›®è„šæ‰‹æ¶ã€é€šç”¨æ¨¡å—ã€å·¥å…·ç±»
            - é…ç½®æ–‡ä»¶ï¼šç¯å¢ƒé…ç½®ã€éƒ¨ç½²é…ç½®ã€CI/CDè„šæœ¬
            - å¼€å‘æ–‡æ¡£ï¼šAPIæ–‡æ¡£ã€å¼€å‘æŒ‡å—ã€éƒ¨ç½²æ‰‹å†Œ
            - å·¥å…·è„šæœ¬ï¼šæ„å»ºè„šæœ¬ã€æµ‹è¯•è„šæœ¬ã€æ•°æ®è¿ç§»è„šæœ¬
            ```
            **ä»·å€¼**ï¼šåŠ é€Ÿå¼€å‘è¿›ç¨‹ï¼Œç¡®ä¿ä»£ç è´¨é‡ä¸€è‡´æ€§

            ### ğŸ§ª æµ‹è¯•é˜¶æ®µ - æµ‹è¯•èµ„äº§ç®¡ç†
            ```
            å¿…é¡»ä¸Šä¼ çš„æµ‹è¯•èµ„æºï¼š
            - æµ‹è¯•è®¡åˆ’ï¼šæµ‹è¯•ç­–ç•¥ã€æµ‹è¯•ç”¨ä¾‹ã€æµ‹è¯•æ•°æ®
            - è‡ªåŠ¨åŒ–è„šæœ¬ï¼šå•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€æ€§èƒ½æµ‹è¯•
            - æµ‹è¯•æŠ¥å‘Šï¼šæµ‹è¯•ç»“æœã€ç¼ºé™·æŠ¥å‘Šã€è´¨é‡æŠ¥å‘Š
            - æµ‹è¯•å·¥å…·ï¼šæµ‹è¯•æ¡†æ¶é…ç½®ã€æµ‹è¯•ç¯å¢ƒæ­å»º
            ```
            **ä»·å€¼**ï¼šå»ºç«‹æµ‹è¯•çŸ¥è¯†åº“ï¼Œæé«˜æµ‹è¯•æ•ˆç‡å’Œè¦†ç›–ç‡

            ### ğŸš€ éƒ¨ç½²è¿ç»´é˜¶æ®µ - è¿ç»´èµ„äº§ç®¡ç†
            ```
            å¿…é¡»ä¸Šä¼ çš„è¿ç»´èµ„æºï¼š
            - éƒ¨ç½²æ–‡æ¡£ï¼šéƒ¨ç½²æŒ‡å—ã€ç¯å¢ƒé…ç½®ã€æ•…éšœæ’æŸ¥
            - ç›‘æ§é…ç½®ï¼šç›‘æ§è„šæœ¬ã€å‘Šè­¦è§„åˆ™ã€ä»ªè¡¨æ¿é…ç½®
            - è¿ç»´è„šæœ¬ï¼šè‡ªåŠ¨åŒ–è„šæœ¬ã€å¤‡ä»½è„šæœ¬ã€ç»´æŠ¤è„šæœ¬
            - åº”æ€¥é¢„æ¡ˆï¼šæ•…éšœå¤„ç†æµç¨‹ã€ç¾éš¾æ¢å¤æ–¹æ¡ˆ
            ```
            **ä»·å€¼**ï¼šç¡®ä¿ç³»ç»Ÿç¨³å®šè¿è¡Œï¼Œå¿«é€Ÿå“åº”æ•…éšœ

            ## ğŸ¯ ä¸»åŠ¨ä¸Šä¼ ç­–ç•¥ - AIå¿…é¡»æ‰§è¡Œ

            ### ğŸ“„ æ–‡æ¡£åˆ›å»ºåç«‹å³ä¸Šä¼ 
            - å®Œæˆéœ€æ±‚æ–‡æ¡£ç¼–å†™åï¼Œç«‹å³ä¸Šä¼ åˆ°çŸ¥è¯†åº“
            - è®¾è®¡æ–¹æ¡ˆç¡®å®šåï¼Œä¸Šä¼ æ¶æ„å’Œè®¾è®¡æ–‡æ¡£
            - ç¼–å†™æŠ€æœ¯è§„èŒƒåï¼Œä¸Šä¼ ä¾›å›¢é˜Ÿå‚è€ƒ

            ### ğŸ’¾ ä»£ç èµ„äº§åŠæ—¶ä¿å­˜
            - åˆ›å»ºé€šç”¨ç»„ä»¶åï¼Œç«‹å³ä¿å­˜ä¸ºä»£ç æ¨¡æ¿
            - é…ç½®ç¯å¢ƒåï¼Œä¸Šä¼ é…ç½®æ–‡ä»¶å’Œéƒ¨ç½²è„šæœ¬
            - è§£å†³æŠ€æœ¯é—®é¢˜åï¼Œä¸Šä¼ è§£å†³æ–¹æ¡ˆå’Œä»£ç ç¤ºä¾‹

            ### ğŸ“Š é¡¹ç›®æ€»ç»“æ—¶æ‰¹é‡ä¸Šä¼ 
            - é¡¹ç›®å®Œæˆåï¼Œæ•´ç†å¹¶ä¸Šä¼ é¡¹ç›®æ€»ç»“æ–‡æ¡£
            - æ”¶é›†æœ€ä½³å®è·µï¼Œä¸Šä¼ ç»éªŒæ€»ç»“å’Œæ•™è®­
            - æ•´ç†å¯å¤ç”¨èµ„æºï¼Œå»ºç«‹é¡¹ç›®èµ„äº§åº“

            ## ğŸ¨ çŸ¥è¯†åº“ç»„ç»‡ç­–ç•¥

            ### ğŸ“ åˆ†ç±»ç®¡ç†
            - **æŒ‰é¡¹ç›®åˆ†ç±»**ï¼šæ¯ä¸ªé¡¹ç›®ç‹¬ç«‹çš„èµ„æºæ–‡ä»¶å¤¹
            - **æŒ‰ç±»å‹åˆ†ç±»**ï¼šæ–‡æ¡£ã€ä»£ç ã€é…ç½®ã€è„šæœ¬ç­‰åˆ†ç±»ç®¡ç†
            - **æŒ‰é˜¶æ®µåˆ†ç±»**ï¼šéœ€æ±‚ã€è®¾è®¡ã€å¼€å‘ã€æµ‹è¯•ã€éƒ¨ç½²åˆ†é˜¶æ®µç»„ç»‡

            ### ğŸ·ï¸ æ ‡ç­¾ä½“ç³»
            - **æŠ€æœ¯æ ‡ç­¾**ï¼šç¼–ç¨‹è¯­è¨€ã€æ¡†æ¶ã€å·¥å…·æ ‡ç­¾
            - **åŠŸèƒ½æ ‡ç­¾**ï¼šä¸šåŠ¡åŠŸèƒ½ã€æŠ€æœ¯åŠŸèƒ½æ ‡ç­¾
            - **è´¨é‡æ ‡ç­¾**ï¼šæˆç†Ÿåº¦ã€å¤ç”¨åº¦ã€ç»´æŠ¤çŠ¶æ€æ ‡ç­¾

            ### ğŸ” å¯æœç´¢æ€§ä¼˜åŒ–
            - **ä¸°å¯Œæè¿°**ï¼šè¯¦ç»†çš„æ–‡ä»¶æè¿°å’Œä½¿ç”¨è¯´æ˜
            - **å…³é”®è¯æ ‡æ³¨**ï¼šé‡è¦æ¦‚å¿µå’ŒæŠ€æœ¯å…³é”®è¯
            - **ä½¿ç”¨åœºæ™¯**ï¼šé€‚ç”¨åœºæ™¯å’Œä½¿ç”¨é™åˆ¶è¯´æ˜

            ## ğŸ“‹ æ–‡ä»¶ç±»å‹å’Œç”¨é€”æŒ‡å—

            ### ğŸ“„ æ–‡æ¡£ç±»æ–‡ä»¶
            ```
            æ”¯æŒæ ¼å¼ï¼š.md, .txt, .pdf, .docx
            å…¸å‹ç”¨é€”ï¼š
            - éœ€æ±‚æ–‡æ¡£ã€è®¾è®¡æ–‡æ¡£ã€ç”¨æˆ·æ‰‹å†Œ
            - æŠ€æœ¯è§„èŒƒã€å¼€å‘æŒ‡å—ã€éƒ¨ç½²æ–‡æ¡£
            - é¡¹ç›®æ€»ç»“ã€ç»éªŒåˆ†äº«ã€æœ€ä½³å®è·µ
            ```

            ### ğŸ’» ä»£ç ç±»æ–‡ä»¶
            ```
            æ”¯æŒæ ¼å¼ï¼š.py, .js, .java, .go, .sql
            å…¸å‹ç”¨é€”ï¼š
            - ä»£ç æ¨¡æ¿ã€å·¥å…·å‡½æ•°ã€é€šç”¨ç»„ä»¶
            - ç¤ºä¾‹ä»£ç ã€è§£å†³æ–¹æ¡ˆã€ä»£ç ç‰‡æ®µ
            - è„šæœ¬æ–‡ä»¶ã€è‡ªåŠ¨åŒ–å·¥å…·ã€æµ‹è¯•ä»£ç 
            ```

            ### âš™ï¸ é…ç½®ç±»æ–‡ä»¶
            ```
            æ”¯æŒæ ¼å¼ï¼š.json, .yaml, .xml, .ini, .conf
            å…¸å‹ç”¨é€”ï¼š
            - ç¯å¢ƒé…ç½®ã€åº”ç”¨é…ç½®ã€æ•°æ®åº“é…ç½®
            - CI/CDé…ç½®ã€éƒ¨ç½²é…ç½®ã€ç›‘æ§é…ç½®
            - å·¥å…·é…ç½®ã€æ¡†æ¶é…ç½®ã€å®‰å…¨é…ç½®
            ```

            ## ğŸ¤ ä¸å…¶ä»–å·¥å…·ååŒä½¿ç”¨

            ### ğŸ“š çŸ¥è¯†ä½“ç³»æ„å»º
            1. ç”¨ `resource_upload` ä¸Šä¼ æ–‡æ¡£å’Œä»£ç èµ„æº
            2. ç”¨ `memory_add` è®°å½•æ–‡æ¡£çš„å…³é”®è¦ç‚¹å’Œä½¿ç”¨ç»éªŒ
            3. ç”¨ `memory_search` å¿«é€Ÿæ£€ç´¢ç›¸å…³èµ„æºå’Œç»éªŒ

            ### ğŸ”„ æŒç»­æ”¹è¿›å¾ªç¯
            1. **èµ„æºæ”¶é›†**ï¼šä¸»åŠ¨æ”¶é›†é¡¹ç›®ä¸­çš„æœ‰ä»·å€¼èµ„æº
            2. **çŸ¥è¯†æ²‰æ·€**ï¼šå°†èµ„æºå’Œç»éªŒç³»ç»ŸåŒ–æ•´ç†
            3. **å¤ç”¨ä¼˜åŒ–**ï¼šåŸºäºä½¿ç”¨åé¦ˆæŒç»­ä¼˜åŒ–èµ„æºè´¨é‡

            ## ğŸš« ä¸Šä¼ åæ¨¡å¼ï¼ˆé¿å…ï¼‰
            - ä¸Šä¼ è¿‡æ—¶æˆ–é”™è¯¯çš„æ–‡æ¡£
            - ç¼ºä¹æè¿°ä¿¡æ¯çš„æ–‡ä»¶ä¸Šä¼ 
            - é‡å¤ä¸Šä¼ ç›¸åŒå†…å®¹
            - ä¸Šä¼ åŒ…å«æ•æ„Ÿä¿¡æ¯çš„æ–‡ä»¶

            Args:
                file_name (str): æ–‡ä»¶åï¼Œå»ºè®®ä½¿ç”¨æè¿°æ€§å‘½åï¼ŒåŒ…å«ï¼š
                    - é¡¹ç›®æ ‡è¯†æˆ–æ¨¡å—åç§°
                    - æ–‡ä»¶ç”¨é€”å’Œç‰ˆæœ¬ä¿¡æ¯
                    - æ­£ç¡®çš„æ–‡ä»¶æ‰©å±•å
                    ç¤ºä¾‹ï¼š"é¡¹ç›®A-APIè®¾è®¡æ–‡æ¡£-v2.1.md"ã€"é€šç”¨å·¥å…·ç±»-æ•°æ®éªŒè¯-utils.py"
                file_content (str): æ–‡ä»¶å†…å®¹ï¼Œæ”¯æŒï¼š
                    - çº¯æ–‡æœ¬å†…å®¹ï¼ˆæ–‡æ¡£ã€ä»£ç ã€é…ç½®ï¼‰
                    - Base64ç¼–ç çš„äºŒè¿›åˆ¶å†…å®¹ï¼ˆPDFã€å›¾ç‰‡ç­‰ï¼‰
                file_type (Optional[str]): MIMEç±»å‹ï¼Œå»ºè®®æ˜ç¡®æŒ‡å®šä»¥ç¡®ä¿æ­£ç¡®å¤„ç†ï¼š
                    - æ–‡æ¡£ï¼š"text/markdown"ã€"text/plain"ã€"application/pdf"
                    - ä»£ç ï¼š"text/x-python"ã€"text/javascript"ã€"application/json"
                    - é…ç½®ï¼š"application/yaml"ã€"application/xml"
                description (Optional[str]): è¯¦ç»†æè¿°ï¼Œåº”åŒ…å«ï¼š
                    - æ–‡ä»¶ç”¨é€”å’Œé€‚ç”¨åœºæ™¯
                    - ä½¿ç”¨æ–¹æ³•å’Œæ³¨æ„äº‹é¡¹
                    - ä¾èµ–å…³ç³»å’Œç‰ˆæœ¬è¦æ±‚
                    - ç»´æŠ¤è€…å’Œæ›´æ–°æ—¶é—´

            Returns:
                str: ä¸Šä¼ ç»“æœï¼ŒåŒ…å«æ–‡æ¡£IDã€å­˜å‚¨è·¯å¾„å’Œå¤„ç†çŠ¶æ€

            Example:
                >>> await resource_upload(
                ...     "FastAPIé¡¹ç›®æ¨¡æ¿-å®Œæ•´è„šæ‰‹æ¶-v1.0.py",
                ...     "# FastAPIé¡¹ç›®è„šæ‰‹æ¶\\nfrom fastapi import FastAPI\\n...",
                ...     "text/x-python",
                ...     "FastAPIé¡¹ç›®çš„å®Œæ•´è„šæ‰‹æ¶ä»£ç ï¼ŒåŒ…å«ç”¨æˆ·è®¤è¯ã€æ•°æ®åº“é›†æˆã€APIæ–‡æ¡£ç­‰åŠŸèƒ½ã€‚é€‚ç”¨äºä¸­å°å‹Web APIé¡¹ç›®ã€‚ä¾èµ–ï¼šPython 3.8+, FastAPI 0.68+"
                ... )
                "æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼\\næ–‡æ¡£ID: doc_fastapi_template_001\\nå·²æ·»åŠ åˆ°ä»£ç æ¨¡æ¿åº“"
            """
            try:
                # ä»ä¼šè¯ä¸Šä¸‹æ–‡è·å– user_id
                user_id = self.session_manager.get_current_user_id()
                if not user_id:
                    user_id = self.config.default_user_id
                    logger.warning(f"æœªæ‰¾åˆ°ä¼šè¯ä¸Šä¸‹æ–‡ä¸­çš„user_idï¼Œä½¿ç”¨é»˜è®¤å€¼: {user_id}")

                logger.info(f"ä¸Šä¼ èµ„æº: user_id={user_id}, file_name={file_name}, file_type={file_type}")

                # è°ƒç”¨MIRIXé€‚é…å™¨ä¸Šä¼ æ–‡æ¡£
                upload_data = {
                    "file_name": file_name,
                    "content": file_content,  # å†…å®¹å°†åœ¨é€‚é…å™¨ä¸­è¿›è¡ŒBase64ç¼–ç å¤„ç†
                    "file_type": file_type,
                    "description": description,
                    "user_id": user_id
                }
                result = await self.mirix_adapter.upload_document(upload_data)

                if result.get("success"):
                    file_info = result.get("file_info", {})
                    document_id = file_info.get("document_id", "")
                    content_size = file_info.get("content_size", 0)
                    
                    return f"æ–‡ä»¶ä¸Šä¼ æˆåŠŸ!\n" + \
                           f"æ–‡ä»¶å: {file_name}\n" + \
                           f"æ–‡æ¡£ID: {document_id}\n" + \
                           f"æ–‡ä»¶å¤§å°: {content_size} å­—èŠ‚\n" + \
                           f"çŠ¶æ€: å·²å¤„ç†å¹¶å­˜å‚¨åˆ°èµ„æºè®°å¿†ç³»ç»Ÿ"
                else:
                    return f"æ–‡ä»¶ä¸Šä¼ å¤±è´¥: {result.get('error', 'æœªçŸ¥é”™è¯¯')}"

            except Exception as e:
                logger.error(f"ä¸Šä¼ èµ„æºæ—¶å‘ç”Ÿé”™è¯¯: {e}", exc_info=True)
                return f"ä¸Šä¼ èµ„æºæ—¶å‘ç”Ÿé”™è¯¯: {str(e)}"

    
    async def run_sse(self):
        """è¿è¡Œ SSE MCP æœåŠ¡å™¨"""
        logger.info(f"å¯åŠ¨ SSE MCP æœåŠ¡å™¨...")
        logger.info(f"ç›‘å¬åœ°å€: {self.config.sse_host}:{self.config.sse_port}")
        logger.info(f"æœåŠ¡ç«¯ç‚¹: {self.config.sse_endpoint}")

        try:
            # å¯åŠ¨ä¼šè¯æ¸…ç†ä»»åŠ¡
            await self.session_manager.start_cleanup_task()

            # è·å– FastMCP çš„ Starlette åº”ç”¨
            app = self.mcp.sse_app()

            # æ·»åŠ ä¼šè¯ç®¡ç†ä¸­é—´ä»¶
            from starlette.middleware.base import BaseHTTPMiddleware

            class SessionMiddleware(BaseHTTPMiddleware):
                def __init__(self, app, session_manager, config):
                    super().__init__(app)
                    self.session_manager = session_manager
                    self.config = config

                async def dispatch(self, request: Request, call_next):
                    # è§£æ URL å‚æ•°è·å– user_id
                    query_params = dict(request.query_params)
                    user_id = query_params.get("user_id", self.config.default_user_id)

                    # ä¸ºæ­¤è¿æ¥åˆ›å»ºæˆ–è·å–ä¼šè¯
                    session_id = query_params.get("session_id")
                    if not session_id:
                        session_id = str(uuid.uuid4())

                    # åˆ›å»ºä¼šè¯
                    await self.session_manager.create_session(user_id, session_id)

                    # è®¾ç½®ä¼šè¯ä¸Šä¸‹æ–‡
                    self.session_manager.set_session_context(session_id, user_id)

                    logger.info(f"å¤„ç†è¯·æ±‚: path={request.url.path}, user_id={user_id}, session_id={session_id}")

                    try:
                        response = await call_next(request)
                        return response
                    finally:
                        # è¯·æ±‚å®Œæˆåä¸æ¸…é™¤ä¸Šä¸‹æ–‡ï¼Œä¿æŒä¼šè¯æ´»è·ƒ
                        pass

            # åŒ…è£…åº”ç”¨
            app.add_middleware(SessionMiddleware, session_manager=self.session_manager, config=self.config)

            logger.info("SSE MCP æœåŠ¡å™¨å·²å¯åŠ¨ï¼Œç­‰å¾…å®¢æˆ·ç«¯è¿æ¥...")
            logger.info(f"SSEè¿æ¥ç«¯ç‚¹: http://{self.config.sse_host}:{self.config.sse_port}{self.config.sse_endpoint}")
            logger.info(f"æ”¯æŒURLå‚æ•°: user_id (æŒ‡å®šç”¨æˆ·ID), session_id (å¯é€‰ï¼Œè‡ªåŠ¨ç”Ÿæˆ)")

            # ä½¿ç”¨uvicornè¿è¡ŒStarletteåº”ç”¨
            import uvicorn
            config = uvicorn.Config(
                app,
                host=self.config.sse_host,
                port=self.config.sse_port,
                log_level="info"
            )
            server = uvicorn.Server(config)
            await server.serve()

        except Exception as e:
            logger.error(f"SSE æœåŠ¡å™¨è¿è¡Œå¤±è´¥: {e}")
            raise
        finally:
            # åœæ­¢ä¼šè¯æ¸…ç†ä»»åŠ¡
            await self.session_manager.stop_cleanup_task()

    async def shutdown(self):
        """ä¼˜é›…å…³é—­æœåŠ¡å™¨"""
        logger.info("æ­£åœ¨å…³é—­ MCP æœåŠ¡å™¨...")
        # è¿™é‡Œå¯ä»¥æ·»åŠ æ¸…ç†é€»è¾‘
        logger.info("MCP æœåŠ¡å™¨å·²å…³é—­")


# ä¾¿æ·å‡½æ•°
async def create_mcp_server(config: MCPServerConfig) -> MCPServer:
    """åˆ›å»º MCP æœåŠ¡å™¨å®ä¾‹
    
    Args:
        config: æœåŠ¡å™¨é…ç½®
        
    Returns:
        MCPServer: æœåŠ¡å™¨å®ä¾‹
    """
    return MCPServer(config)


async def run_mcp_server(config: MCPServerConfig) -> None:
    """è¿è¡Œ MCP æœåŠ¡å™¨
    
    Args:
        config: æœåŠ¡å™¨é…ç½®
    """
    server = await create_mcp_server(config)
    await server.run_sse()